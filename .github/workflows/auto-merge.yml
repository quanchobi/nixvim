name: Auto-merge Flake Updates

on:
  schedule:
    # Run at 02:00 UTC on the 1st of every month (after checks complete)
    - cron: "0 2 1 * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if update PR exists
        id: check_pr
        run: |
          PR_NUMBER=$(gh pr list --head update-flake-lock --json number --jq '.[0].number')
          if [ -z "$PR_NUMBER" ]; then
            echo "No update PR found"
            echo "exists=false" >> $GITHUB_OUTPUT
          else
            echo "Found PR #$PR_NUMBER"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for checks to complete
        if: steps.check_pr.outputs.exists == 'true'
        run: |
          echo "Waiting for checks on PR #${{ steps.check_pr.outputs.number }}"
          gh pr checks ${{ steps.check_pr.outputs.number }} --watch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge PR if checks passed
        if: steps.check_pr.outputs.exists == 'true'
        run: |
          gh pr merge ${{ steps.check_pr.outputs.number }} --squash --auto
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
